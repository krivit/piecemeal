% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/Piecemeal.R
\name{Piecemeal}
\alias{Piecemeal}
\title{A class for setting up and running large simulations piecemeal}
\description{
A class for setting up and running large simulations piecemeal

A class for setting up and running large simulations piecemeal
}
\details{
This class facilitates simulation studies made up of many relatively small replications and treatment configurations in a setting (such as a shared a computing cluster) in which the parallel processing may be interrupted due to time limits, errors, or for other reasons. Regular implementations, such as, \pkg{parallel}, execute the worker function for each configuration of interest and then return the result list. This means that if the process is interrupted due to, say, the job running out of time, all results are lost. \code{Piecemeal} instead saves the result of each treatment level and seed combination into its own file, then collates the results at the end.

A chain of \code{R6} method calls is used to specify the setup and the worker functions, the treatment configurations to be passed to the worker, and parallelism and other simulation settings. Then, when \verb{$run()} is called, the cluster is started, worker nodes are initialised, and every combination of random seed and treatment configuration is passed to \code{\link[=clusterApplyLB]{clusterApplyLB()}}.

On the worker nodes, the worker function is not called directly; rather, care is taken to make sure that the specified configuration and seed is not already being worked on. This makes it safe to, e.g., queue multiple jobs for the same simulation. If the configuration is available, \code{set.seed()} is called with the seed and then the worker function is run.

Errors in the worker function are caught and error messages saved and returned.
}
\examples{

outdir <- file.path(tempdir(), "piecemeal_demo")

# New simulation study.
runner <- Piecemeal$new(outdir)
runner$reset(FALSE) # Reset, just in case.

runner$ # Set up the following simulation study:
# a socket cluster with 2 nodes;
  cluster(2)$
# a factorial design with x = 1, 5, 25 and y = 1, 3, 9, 27;
  factorial(x = 5^(0:2), y = 3^(0:3))$
# with 2 replications per combination of x and y
  nrep(2)$
# calling a function of x and y, returning their product and a random number between 0 and 1;
  worker(function(x, y) c(prod = x*y, u = runif(1)))$
# and using one level of directory splitting.
  options(split = 1)

# Run this setup; note the invisible output.
head(runner$run())
# Running again, already done.
head(runner$run())

# Collate into a data frame.
(out <- runner$collate())

runner$reset(FALSE) # Reset, just in case.

# We can also run this without a cluster; this could be useful in debugging.
runner$cluster(NULL)
runner$run()
identical(out, runner$collate())

}
\section{Methods}{
\subsection{Public methods}{
\itemize{
\item \href{#method-Piecemeal-new}{\code{Piecemeal$new()}}
\item \href{#method-Piecemeal-cluster}{\code{Piecemeal$cluster()}}
\item \href{#method-Piecemeal-send_vars}{\code{Piecemeal$send_vars()}}
\item \href{#method-Piecemeal-setup}{\code{Piecemeal$setup()}}
\item \href{#method-Piecemeal-worker}{\code{Piecemeal$worker()}}
\item \href{#method-Piecemeal-treatments}{\code{Piecemeal$treatments()}}
\item \href{#method-Piecemeal-factorial}{\code{Piecemeal$factorial()}}
\item \href{#method-Piecemeal-nrep}{\code{Piecemeal$nrep()}}
\item \href{#method-Piecemeal-seeds}{\code{Piecemeal$seeds()}}
\item \href{#method-Piecemeal-run}{\code{Piecemeal$run()}}
\item \href{#method-Piecemeal-todo}{\code{Piecemeal$todo()}}
\item \href{#method-Piecemeal-collate}{\code{Piecemeal$collate()}}
\item \href{#method-Piecemeal-reset}{\code{Piecemeal$reset()}}
\item \href{#method-Piecemeal-options}{\code{Piecemeal$options()}}
\item \href{#method-Piecemeal-clone}{\code{Piecemeal$clone()}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-new"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-new}{}}}
\subsection{Method \code{new()}}{
Create a new \code{Piecemeal} instance.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$new(outdir)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{outdir}}{the directory to hold the partial simulation results.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-cluster"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-cluster}{}}}
\subsection{Method \code{cluster()}}{
Cluster settings for the piecemeal run.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$cluster(...)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{...}}{either arguments to \code{\link[=makeCluster]{makeCluster()}} or a single argument containing either an existing cluster or \code{NULL} to disable clustering.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-send_vars"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-send_vars}{}}}
\subsection{Method \code{send_vars()}}{
Specify variables to be copied from the manager node to the worker nodes' global environment.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$send_vars(varlist, .add = TRUE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{varlist}}{a character vector with variable names.}

\item{\code{.add}}{whether the new variables should be added to the current list (if \code{TRUE}, the default) or replace it (if \code{FALSE}).}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-setup"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-setup}{}}}
\subsection{Method \code{setup()}}{
Specify code to be run on each worker node at the start of the simulation.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$setup(expr)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{expr}}{an expression; if passed, replaces the previous expression; if empty, resets it to nothing.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-worker"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-worker}{}}}
\subsection{Method \code{worker()}}{
Specify the function to be run for each treatment configuration.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$worker(fun)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{fun}}{a function whose arguments are specified by \verb{$treatments()} and \verb{$factorial()}.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-treatments"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-treatments}{}}}
\subsection{Method \code{treatments()}}{
Specify a list of treatment configurations to be run.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$treatments(l, .add = TRUE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{l}}{a list, typically of lists of arguments to be passed to the function specified by \code{worker}; it is recommended that these be as compact as possible, since they are \code{\link{serialize}}d and sent to the worker node for every combination of treatment configuration and random seed.}

\item{\code{.add}}{whether the new treatment configurations should be added to the current list (if \code{TRUE}, the default) or replace it (if \code{FALSE}.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-factorial"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-factorial}{}}}
\subsection{Method \code{factorial()}}{
Specify a list of treatment configurations to be run in a factorial design.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$factorial(..., .filter = function(...) TRUE, .add = TRUE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{...}}{vectors or lists whose Cartesian product will added to the treatment list; it is recommended that these be as compact as possible, since they are \code{\link{serialize}}d and sent to the worker node for every combination of treatment configuration and random seed.}

\item{\code{.filter}}{a function that takes the same arguments as worker and returns \code{FALSE} if the treatment configuration should be skipped; defaults to accepting all configurations.}

\item{\code{.add}}{whether the new treatment configurations should be added to the current list (if \code{TRUE}, the default) or replace it (if \code{FALSE}.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-nrep"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-nrep}{}}}
\subsection{Method \code{nrep()}}{
Specify a number of replications for each treatment configuration.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$nrep(nrep)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{nrep}}{a positive integer giving the number of replications; the seeds will be set to \code{1:nrep}.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-seeds"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-seeds}{}}}
\subsection{Method \code{seeds()}}{
Specify the seeds to be used for each replication of each treatment configuration.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$seeds(seeds)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{seeds}}{an integer vector of seeds; its length will be used to infer the number of replications.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-run"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-run}{}}}
\subsection{Method \code{run()}}{
Run the simulation.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$run(shuffle = TRUE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{shuffle}}{Should the treatment configurations be run in a random order (\code{TRUE}, the default) or in the order in which they were added (\code{FALSE})?}
}
\if{html}{\out{</div>}}
}
\subsection{Returns}{
Invisibly, a character vector with an element for each seed and treatment configuration combination attempted, indicating its file name and status, including errors.
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-todo"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-todo}{}}}
\subsection{Method \code{todo()}}{
List the configurations still to be run.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$todo()}\if{html}{\out{</div>}}
}

\subsection{Returns}{
A list of lists with arguments to the worker functions.
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-collate"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-collate}{}}}
\subsection{Method \code{collate()}}{
Scan through the results files and collate them into a data frame.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$collate(trt_tf = identity, out_tf = identity)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{trt_tf, out_tf}}{functions that take the treatment configuration list and the output respectively, and return lists that can be used as data frame columns.}
}
\if{html}{\out{</div>}}
}
\subsection{Returns}{
A data frame with columns corresponding to the values returned by \code{trt_tf} and \code{out_tf}, with the following additional columns:
\describe{
\item{\code{.seed}}{the random seed used.}
\item{\code{.trt_hash}}{the hash of the treatment configuration.}
\item{\code{.rds}}{the path to the RDS file}
}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-reset"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-reset}{}}}
\subsection{Method \code{reset()}}{
Clear the simulation results so far.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$reset(confirm = interactive())}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{confirm}}{whether the user should be prompted to confirm deletion.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-options"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-options}{}}}
\subsection{Method \code{options()}}{
Set miscellaneous options.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$options(split = 0L, error = c("skip", "save"))}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{split}}{whether the output files should be split up into subdirectories and how deeply; this can improve performance on some file systems.}

\item{\code{error}}{how to handle worker errors:\describe{
\item{\code{"skip"}}{return the error message as a part of \code{run()}'s return value, but do not save the RDS file; the next \code{run()} will attempt to run the worker for that configuration and seed again;}
\item{\code{"save"}}{save the seed, the configuration, and the status, preventing future runs until the file is cleared.}
}}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-Piecemeal-clone"></a>}}
\if{latex}{\out{\hypertarget{method-Piecemeal-clone}{}}}
\subsection{Method \code{clone()}}{
The objects of this class are cloneable with this method.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{Piecemeal$clone(deep = FALSE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{deep}}{Whether to make a deep clone.}
}
\if{html}{\out{</div>}}
}
}
}
